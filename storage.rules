rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ===== Helper Functions =====
    function isSignedIn() {
      return request.auth != null;
    }

    function isValidSize() {
      // Limit uploads to 20 MB
      return request.resource.size < 20 * 1024 * 1024;
    }

    function isAllowedType() {
      // Allow only safe content types
      return request.resource.contentType.matches('image/.*') ||
             request.resource.contentType.matches('video/.*') ||
             request.resource.contentType == 'application/pdf' ||
             request.resource.contentType == 'application/octet-stream';
    }

    // ===== General Read Access =====
    // Allow read for authenticated users (you can make this public if you prefer)
    match /{allPaths=**} {
      allow read: if isSignedIn();
    }

    // ===== Upload Paths =====
    // Used by MoveForm to upload images/videos/documents
    match /uploads/{requestId}/{filename} {
      allow write: if isSignedIn() && isValidSize() && isAllowedType();
      allow delete: if isSignedIn(); // optional: allow users to delete their own uploads
    }

    // ===== Chat Attachments =====
    match /chat/{requestId}/{filename} {
      allow write: if isSignedIn() && isValidSize() && isAllowedType();
      allow delete: if isSignedIn();
    }

    // ===== Company Documents =====
    // e.g., proof of insurance, company certificate
    match /companies/{companyId}/{filename} {
      allow write: if isSignedIn() && request.auth.uid == companyId && isValidSize() && isAllowedType();
      allow read: if isSignedIn();
      allow delete: if request.auth.uid == companyId;
    }

    // ===== Admin Uploads (optional future use) =====
    match /admin/{path=**} {
      allow read, write, delete: if isSignedIn();
    }
  }
}
